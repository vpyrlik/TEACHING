---
title: "Семинар 1. Эмпирическая часть."
date: '2022-09-06'
output:  
  html_document:  
    self_contained: no  
    theme: cosmo
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 2
mainfont: Liberation Serif
monofont: Liberation Mono
---

Эмпирическая часть семинаров проводится на языке программирования [R](https://cran.r-project.org/) с использованием среды разработки [RStudio](https://www.rstudio.com/). В этой инструкции вам предлагается вспомнить основные команды, необходимые для обработки и анализа данных в R. 

Для начала загружаем необходимые пакеты.

## Загрузка пакетов

Начнем с загрузки пакетов, которые нужны нам для работы (предварительно все они должны быть установлены). Мы рекомендуем использовать команды из этих пакетов, но существует и множество других способов --- выбирайте тот, который вам больше нравится.

```{r, message=FALSE}
library(AER)     # пакет содержит наборы данных, используемые в учебнике Стока и Уотсона
library(dplyr)   # манипуляции с данными
library(tidyr)   # манипуляции с данными
library(ggplot2) # визуализация данных
```

## Загрузка данных

В этом примере мы работаем данными [Current Population Survey (CPS)](https://en.wikipedia.org/wiki/Current_Population_Survey). Фрагмент данных можно загрузить, используя встроенный набор данных пакета [AER](https://rdrr.io/cran/AER/man/CPSSW.html) (используйте набор данных `CPSSWEducation`).

Загрузим встроенный набор данных. 

```{r}
data("CPSSWEducation")
```

## Разведочный анализ данных

Изучите загруженный набор данных. 

### Предварительное ознакомление с данными и первичная обработка

Посмотрите, какие переменные содержатся в данных и какой тип у этих переменных. 
Для предварительного просмотра данных можно использовать команды `View()`, `dplyr::glimpse()` и проч. 

```{r}
CPSSWEducation %>% glimpse() # то же самое, что glimpse(CPSSWEducation)
```

Иногда бывает необходимо создавать новые переменные. Это можно сделать при помощи команды `dplyr::mutate()`. Например, создадим переменную, равную 1 для людей с образованием выше среднего (будем считать такими тех, у кого количество лет образования больше 11) и 0 для всех остальных. 

```{r}
CPSSWEducation <- CPSSWEducation %>% mutate(edulevel = ifelse(education > 11, 1, 0))
```


### Описательные статистики

Важнейшей частью разведочного анализа является построение таблицы с описательными статистиками. В простом виде основные статистики можно посмотреть через базовую команду `summary()`. 

```{r}
CPSSWEducation %>% summary()
```

Более сложный, но гибкий и полезный способ --- использовать команду `dplyr::summarise()` в комбинации с другими командами пакетов `dplyr` и `tidyr`. 

```{r}
CPSSWEducation %>%
  summarise(across(where(is.numeric), 
                   list(mean = mean, median = median, sd = sd, min = min, max = max), 
                   na.rm = TRUE)) %>% 
  pivot_longer(everything(), names_to = "name", values_to = "value") %>% 
  separate(name, c("variable", "statistic"), sep = "_") %>%
  pivot_wider(names_from = statistic, values_from = value) %>%
  arrange(variable) %>% 
  select(variable, mean, median, sd, min, max)
```



### Графический анализ

Графический анализ данных --- процесс творческий. Команды пакета `ggplot2` позволяют строить самые разные графики. Можно также использовать базовые возможности R и многие другие пакеты. 

Сопоставить между собой непрерывную переменную (например, доход) и дискретную переменную (например, пол) можно, построив "ящик с усами" (boxplot) или график плотности распределения (density plot) отдельно для каждого пола. 

```{r}
CPSSWEducation %>% 
  ggplot(aes(y = earnings, x = gender)) + 
  geom_boxplot()
```

```{r}
CPSSWEducation %>% 
  ggplot(aes(earnings, col = gender, fill = gender)) + 
  geom_density(alpha = 0.25)
```


Визаулизировать связь между двумя непрерывными переменными можно, использую диаграмму рассеяния (scatter plot). В данном конкретном примере переменная `education` не совсем непрерывная, т. к. количество лет образования может принимать только целочисленные значения, но т. к. таких значений достаточно много, можно притвориться, что она таковой является. 

```{r, message=FALSE}
CPSSWEducation %>% 
  ggplot(aes(education, earnings)) +
  geom_jitter(width = 0.25, alpha = 0.5) + 
  geom_smooth(method = "lm", se = FALSE) + 
  scale_x_continuous(name = "Years of education", breaks = seq(6, 18, 1), minor_breaks = FALSE) + 
  scale_y_continuous(name = "Average hourly earnings")
```

Команда `geom_jitter` на графике выше нужна для наглядности, т. к. в противном случае точки бы накладывались друг на друга (попробуйте построить график без этой команды и посмотрите, что выйдет). Дополнительно на графике выше показан способ для подписи осей. В качестве альтернативы можно использовать команды `labs()`, `xlab`, `ylab`. Но по сравнению с ними команда `scale_x_continuous` и `scale_y_continuous` позволяют не только подписывать названия осей, но и редактировать другие элементы осей. 

Также диаграммы рассеяния можно построить отдельно для мужчин и для женщин. 

```{r}
CPSSWEducation %>% 
  ggplot(aes(education, earnings)) +
  geom_jitter(width = 0.25, alpha = 0.5) + 
  geom_smooth(method = "lm", se = FALSE) + 
  scale_x_continuous(name = "Years of education", breaks = seq(6, 18, 1), minor_breaks = FALSE) + 
  scale_y_continuous(name = "Average hourly earnings") + 
  facet_wrap(~gender)
```

```{r}
CPSSWEducation %>% 
  ggplot(aes(education, earnings, col = gender)) +
  geom_jitter(width = 0.25, alpha = 0.5) + 
  geom_smooth(method = "lm", se = FALSE) + 
  scale_x_continuous(name = "Years of education", breaks = seq(6, 18, 1), minor_breaks = FALSE) + 
  scale_y_continuous(name = "Average hourly earnings")
```


## Проведение исследования

Предварительно ознакомившись с данными, можно использовать их для ответа на исследовательские вопросы, применяя методы статистики и эконометрики. 

### Пол и образование

Изучите связь между полом и образованием, оценив их соместное распределение. Для этого можно построить таблицу сопряженности между двумя переменными (можно использовать базовую команду `table()` и другие). На основе данных таблицы оцените основные показатели, характеризующие совместное распределение переменных. **Сделайте содержательные выводы.** 

```{r}
CPSSWEducation %>% select(gender, education) %>% table() # (почти) то же самое, что table(CPSSWEducation$gender, CPSSWEducation$education)
```

В таблице выше представлено количество наблюдений для каждого пола и каждого уровня образования. 

```{r}
(CPSSWEducation %>% select(gender, education) %>% table() / nrow(CPSSWEducation)) %>% round(digits = 3)
```

Аналогично можно сопоставить пол и уровень образования. 

```{r}
CPSSWEducation %>% select(gender, edulevel) %>% table()
```

```{r}
(CPSSWEducation %>% select(gender, edulevel) %>% table() / nrow(CPSSWEducation)) %>% round(digits = 3)
```

### Пол и зарплата

Известная проблема в экономике --- разрыв в уровне заработной платы между мужчинами и женщинами. Еще один вопрос: влияет ли образование на заработную плату и одинакова ли сила этого влияния для мужчин и женщин. Изучите эти проблемы на используемом наборе данных. Для этого рекомендуется рассчитать базовые статистики и построить графики распределения дохода в разрезе по полу и уровню образования. **Сделайте содержательные выводы.** 

```{r}
CPSSWEducation %>% 
  ggplot(aes(earnings)) + 
  geom_density() + 
  facet_grid(gender ~ edulevel)
```

```{r, message=FALSE}
CPSSWEducation %>%
  group_by(gender, edulevel) %>%
  summarise(across(earnings, 
                   list(mean = mean, median = median, sd = sd, min = min, max = max), 
                   na.rm = TRUE)) %>% 
  pivot_longer(-c(gender, edulevel), names_to = "name", values_to = "value") %>% 
  separate(name, c("variable", "statistic"), sep = "_") %>%
  pivot_wider(names_from = statistic, values_from = value) %>%
  arrange(variable, gender, edulevel) %>% 
  select(variable, gender, edulevel, mean, median, sd, min, max)
```
